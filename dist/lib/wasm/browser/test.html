<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>rq_library WASM demo</title>
<style>
body{font-family:sans-serif;margin:2rem;max-width:720px;display:flex;flex-direction:column;gap:1rem}
button{padding:.4rem 1.1rem;font-size:1rem}
#log{border:1px solid #ccc;height:14rem;overflow:auto;white-space:pre-wrap;padding:.7rem}
</style>
</head>
<body>

<label>Source file <input type="file" id="src"></label>
<button id="meta">create_metadata</button>
<button id="encode">encode_file</button>

<label>Symbols directory <input type="file" id="symdir" webkitdirectory></label>
<label>Layout file <input type="file" id="layout"></label>
<button id="decode">decode_symbols</button>

<output id="log"></output>

<script type="module">
import init, { RaptorQSession } from './rq_library.js';

const p = str => {const o=document.getElementById('log');o.textContent+=str+'\n';o.scrollTop=o.scrollHeight};

/* --- Normalised‑path, Promise‑returning in‑memory FS ------------------- */
const norm = path => {
  if(!path) return '/';
  let p = path.startsWith('/') ? path : '/'+path;
  // squash repeated slashes, drop trailing
  p = p.replace(/\/+/g,'/'); 
  return p.length>1 && p.endsWith('/') ? p.slice(0,-1) : p;
};

/* utility – synchronously‑resolved “thenable” */
const instant = v => ({ then: (res)=>res(v), ...v });

class VFS {
  files = new Map(); dirs = new Set(['/']);

  mkdir(p){ this.dirs.add(norm(p)); return instant(null); }

  stat(p){
    p = norm(p);
    if (this.files.has(p)) return instant({
      size: this.files.get(p).length,
      is_file:  () => true,
      is_dir:   () => false
    });
    if (this.dirs.has(p))  return instant({
      size: 0,
      is_file:  () => false,
      is_dir:   () => true
    });
    throw `ENOENT ${p}`;               // make Path::exists() return false
  }

  read(p){ return instant(this.files.get(norm(p))); }

  write(p,d){ this.files.set(norm(p), new Uint8Array(d)); return instant(null); }
}

const vfs=new VFS();

/* --- WASM bootstrap ---------------------------------------------------- */
await init();
const session=new RaptorQSession(1024,2,128n,4n);
session.set_filesystem({
  mkdir : p => vfs.mkdir(p),
  stat  : p => vfs.stat(p),
  read  : p => vfs.read(p),
  write : (p,d) => vfs.write(p,d)
});
p('WASM ready ✔');

/* --- UI handlers ------------------------------------------------------- */
document.getElementById('meta').onclick = async () => {
  const f=document.getElementById('src').files[0];
  if(!f) return p('⚠ Pick a source file first');
  await vfs.write('/in.bin', await f.arrayBuffer());
  await vfs.mkdir('/out');
  await session.create_metadata('/in.bin','/out',0,true);
  p('create_metadata ✔  (layout held in memory)');
};

document.getElementById('encode').onclick = async () => {
  if(!await vfs.read('/in.bin')) return p('⚠ Run create_metadata first');
  await session.encode_file('/in.bin','/out',0);
  p('encode_file ✔  (/out now contains symbol files in VFS)');
};

document.getElementById('decode').onclick = async () => {
  const dirFiles=[...document.getElementById('symdir').files];
  const layout=document.getElementById('layout').files[0];
  if(!dirFiles.length||!layout) return p('⚠ Choose symbols dir & layout file');
  await vfs.mkdir('/sym');
  for(const f of dirFiles) await vfs.write('/sym/'+f.name, await f.arrayBuffer());
  await vfs.write('/layout.json', await layout.arrayBuffer());
  await session.decode_symbols('/sym','/decoded.bin','/layout.json');
  const blob=new Blob([await vfs.read('/decoded.bin')]);
  const a=Object.assign(document.createElement('a'),{
    href:URL.createObjectURL(blob),
    download:'decoded.bin',
    textContent:'download decoded.bin'
  });
  document.body.append(a);
  p('decode_symbols ✔  (download link appended)');
};
</script>
</body>
</html>
